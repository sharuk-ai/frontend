<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="Calndo - AI-powered calendar for seamless task and event scheduling." name="description"/>
<meta content="AI calendar, task scheduling, event planning, productivity" name="keywords"/>
<meta content="Calndo" name="author"/>
<title>Calndo - AI-Powered Scheduling</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #4FD1C5, #4299E1); }
        .fab { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .header-transparent { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: #eee;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        .tab-button.active {
            background-color: #fff;
            border-bottom: 2px solid #4FD1C5;
            color: #4FD1C5;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        /* Style for hidden search input */
        .hidden-search-input {
            width: 0;
            opacity: 0;
            transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out;
            padding: 0;
        }
        .visible-search-input {
            width: 100%;
            opacity: 1;
            padding: 12px; /* Restore padding when visible */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<header class="header-transparent absolute top-0 left-0 w-full z-10 p-6">
    <nav class="container mx-auto flex justify-between items-center">
        <a href="#" class="text-2xl font-bold text-teal-600">Calndo</a>
        <div class="space-x-4">
            <a href="#features" class="text-gray-700 hover:text-teal-600 transition duration-300">Features</a>
            <a href="#about" class="text-gray-700 hover:text-teal-600 transition duration-300">About</a>
            <a href="#contact" class="text-gray-700 hover:text-teal-600 transition duration-300">Contact</a>
            <button id="authModalBtn" class="bg-teal-600 text-white px-5 py-2 rounded-full hover:bg-teal-700 transition duration-300">Sign Up / Login</button>
            <button id="logoutBtn" class="bg-red-500 text-white px-5 py-2 rounded-full hover:bg-red-600 transition duration-300 hidden">Logout</button>
        </div>
    </nav>
</header>

<section id="hero" class="gradient-bg text-white py-24 md:py-32 flex items-center min-h-screen relative overflow-hidden">
    <div class="container mx-auto text-center z-10" data-aos="fade-up" data-aos-duration="1000">
        <h1 class="text-4xl md:text-6xl font-extrabold leading-tight mb-6">Your Day, Perfected by AI.</h1>
        <p class="text-xl md:text-2xl mb-10 max-w-2xl mx-auto">Calndo intelligently schedules your tasks and events for ultimate productivity.</p>
        <button id="getStartedBtn" class="bg-white text-teal-600 px-8 py-3 rounded-full text-lg font-semibold hover:bg-gray-100 transition duration-300 shadow-lg">Get Started</button>
    </div>
    <div class="absolute inset-0 z-0 opacity-20">
        <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
            <defs>
                <radialGradient id="grad1" cx="50%" cy="50%" r="50%">
                    <stop offset="0%" stop-color="#4FD1C5" stop-opacity="0.8"/>
                    <stop offset="100%" stop-color="#4299E1" stop-opacity="0"/>
                </radialGradient>
            </defs>
            <circle cx="20" cy="80" r="30" fill="url(#grad1)"/>
            <circle cx="80" cy="20" r="40" fill="url(#grad1)"/>
            <circle cx="50" cy="50" r="25" fill="url(#grad1)"/>
        </svg>
    </div>
</section>

<section id="features" class="py-16 md:py-24 bg-white">
    <div class="container mx-auto text-center" data-aos="fade-up" data-aos-duration="1000">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-12">Unleash Your Productivity</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 px-4">
            <div class="p-6 rounded-lg shadow-md bg-white hover:shadow-xl transition duration-300">
                <div class="text-teal-500 mb-4 text-4xl">üóìÔ∏è</div>
                <h3 class="text-xl font-semibold mb-2">Smart Scheduling</h3>
                <p class="text-gray-600">AI optimizes your calendar, finding the best slots for your tasks.</p>
            </div>
            <div class="p-6 rounded-lg shadow-md bg-white hover:shadow-xl transition duration-300">
                <div class="text-teal-500 mb-4 text-4xl">‚úçÔ∏è</div>
                <h3 class="text-xl font-semibold mb-2">Effortless Task Management</h3>
                <p class="text-gray-600">Add, track, and complete tasks with an intuitive interface.</p>
            </div>
            <div class="p-6 rounded-lg shadow-md bg-white hover:shadow-xl transition duration-300">
                <div class="text-teal-500 mb-4 text-4xl">üó£Ô∏è</div>
                <h3 class="text-xl font-semibold mb-2">Voice Assistant</h3>
                <p class="text-gray-600">Manage your schedule hands-free with simple voice commands.</p>
            </div>
        </div>
    </div>
</section>

<section id="tasks" class="py-16 md:py-24 bg-gray-100 hidden" data-aos="fade-up" data-aos-duration="1000">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-12">Your Personalized Calendar</h2>

        <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Previous</button>
            <h3 id="currentMonthYear" class="text-2xl font-semibold"></h3>
            <button id="nextMonth" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Next</button>
        </div>

        <div id="calendar" class="grid grid-cols-7 gap-1 bg-white rounded-lg shadow-md p-4">
            </div>

        <div class="mt-12 p-6 bg-white rounded-lg shadow-md">
            <h3 class="text-2xl font-semibold mb-6">Tasks for <span id="selectedDateDisplay"></span></h3>
            <p id="taskStatus" class="text-center text-gray-600 my-4 hidden"></p>

            <div class="mb-6 flex items-center space-x-2">
                <button id="toggleSearchBtn" class="p-2 text-gray-600 hover:text-teal-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
                <input type="text" id="taskSearchInput" placeholder="Search tasks..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 hidden-search-input"/>
            </div>

            <form id="taskForm" class="mb-8 flex flex-col md:flex-row gap-4">
                <input type="text" id="taskInput" placeholder="New task description" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
                <label for="taskDateTime" class="block text-sm font-medium text-gray-700">Task Date & Time:</label>
                <input type="datetime-local" id="taskDateTime" class="border p-2 rounded w-full mb-2" required>
                <button type="submit" class="bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition duration-300">Add Task</button>
            </form>

            <div class="mb-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h4 class="text-lg font-semibold text-blue-800 mb-2">AI Task Scheduling Assistant</h4>
                <p class="text-blue-700 mb-4">Let AI suggest an optimal time for your task.</p>
                <input type="text" id="aiTaskInput" placeholder="Task for AI suggestion (e.g., 'Meeting with John')" class="w-full p-3 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3"/>
                <button id="suggestTimeBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">Suggest Time</button>
                <p id="aiSuggestionOutput" class="mt-4 text-blue-900 font-medium hidden"></p>
            </div>

            <div id="taskList" class="space-y-4">
                <p class="text-gray-500 text-center" id="noTasksMessage">No tasks for this day. Add a new one!</p>
            </div>
        </div>
        <button id="voiceAssistantBtn" class="fab bg-purple-600 text-white p-4 rounded-full shadow-lg hover:bg-purple-700 transition duration-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m7 0V5a2 2 0 012-2h2a2 2 0 012 2v6m-6 0H6.5M10 21v-5a2 2 0 00-2-2H6a2 2 0 00-2 2v5m8 0h3.5" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>
        </button>
        <p id="voiceAssistantStatus" class="fixed bottom-20 right-20 text-sm text-gray-700 bg-white p-2 rounded-lg shadow hidden z-1001"></p>

    </div>
</section>


<section id="about" class="py-16 md:py-24 bg-white">
    <div class="container mx-auto px-4 text-center" data-aos="fade-up" data-aos-duration="1000">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-8">About Calndo</h2>
        <p class="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">
            Calndo is your intelligent partner in time management. Leveraging cutting-edge AI, we
            transform the way you organize your day. From suggesting optimal task timings to
            providing a hands-free voice assistant, Calndo is built to boost your productivity
            and help you achieve your goals effortlessly. We believe in making scheduling
            smart, simple, and seamless.
        </p>
    </div>
</section>

<section id="contact" class="py-16 md:py-24 gradient-bg text-white">
    <div class="container mx-auto px-4 text-center" data-aos="fade-up" data-aos-duration="1000">
        <h2 class="text-3xl md:text-4xl font-bold mb-8">Get In Touch</h2>
        <p class="text-lg mb-8 max-w-xl mx-auto">Have questions or feedback? We'd love to hear from you!</p>
        <form class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl" id="contactForm">
            <input type="text" id="contactName" placeholder="Your Name" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-800"/>
            <input type="email" id="contactEmail" placeholder="Your Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-800"/>
            <textarea id="contactMessage" rows="5" placeholder="Your Message" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-800"></textarea>
            <button type="submit" class="bg-teal-600 text-white px-8 py-3 rounded-full hover:bg-teal-700 transition duration-300 font-semibold">Send Message</button>
        </form>
        <p id="contactStatus" class="mt-4 text-white font-medium hidden"></p>
    </div>
</section>

<footer class="bg-gray-800 text-white py-8 text-center">
    <div class="container mx-auto px-4">
        <p>&copy; 2025 Calndo. All rights reserved.</p>
        <div class="mt-4 space-x-4">
            <a href="#" class="text-gray-400 hover:text-white">Privacy Policy</a>
            <a href="#" class="text-gray-400 hover:text-white">Terms of Service</a>
        </div>
    </div>
</footer>

<div id="authModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeAuthModal()">&times;</span>
        <div class="flex justify-center mb-4">
            <button id="loginTab" class="tab-button active">Login</button>
            <button id="signupTab" class="tab-button">Sign Up</button>
        </div>

        <div id="loginContent" class="tab-content active">
            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
                <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
                <button type="submit" class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition duration-300">Login</button>
                <p id="loginStatus" class="text-center text-red-500 mt-2 hidden"></p>
            </form>
        </div>

        <div id="signupContent" class="tab-content">
            <form id="signupForm" class="space-y-4">
                <input type="email" id="signupEmail" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
                <input type="password" id="signupPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
                <button type="submit" class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition duration-300">Sign Up</button>
                <p id="signupStatus" class="text-center text-red-500 mt-2 hidden"></p>
            </form>
        </div>
    </div>
</div>

<div id="editTaskModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeEditTaskModal()">&times;</span>
        <h3 class="text-xl font-semibold mb-4">Edit Task</h3>
        <form id="editTaskForm" class="space-y-4">
            <input type="hidden" id="editTaskId"/>
            <label for="editTaskDescription" class="block text-gray-700">Description:</label>
            <input type="text" id="editTaskDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
            <label for="editTaskDateTime" class="block text-gray-700">Date & Time:</label>
            <input type="datetime-local" id="editTaskDateTime" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="editTaskCompleted" class="form-checkbox h-5 w-5 text-teal-600"/>
                <label for="editTaskCompleted" class="text-gray-700">Completed</label>
            </div>
            <button type="submit" class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition duration-300">Save Changes</button>
            <p id="editTaskStatus" class="text-center text-red-500 mt-2 hidden"></p>
        </form>
    </div>
</div>


<script>
    AOS.init();

    // EmailJS initialization (moved to top of script)
    (function() {
        emailjs.init({
            publicKey: "YOUR_EMAILJS_PUBLIC_KEY", // Replace with your actual Public Key
        });
    })();

    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'http://localhost:5000/api'; // Your backend API base URL

        const authModal = document.getElementById('authModal');
        const emailAuthModal = document.getElementById('emailAuthModal');
        const closeEmailAuthModal = document.getElementById('closeEmailAuthModal');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const emailAuthTitle = document.getElementById('emailAuthTitle');
        const emailAuthForm = document.getElementById('emailAuthForm');
        const emailAuthSubmit = document.getElementById('emailAuthSubmit');
        const logoutBtn = document.getElementById('logoutBtn');
        const heroSection = document.getElementById('hero');
        const tasksSection = document.getElementById('tasks');
        const getStartedBtn = document.getElementById('getStartedBtn');

        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const tasksForDateEl = document.getElementById('tasksForDate');
        const taskListEl = document.getElementById('taskList');
        const addTaskForm = document.getElementById('addTaskForm');
        const taskDescriptionInput = document.getElementById('taskDescription');
        const taskDateTimeInput = document.getElementById('taskDateTime');
        const noTasksMessage = document.getElementById('noTasksMessage');

        let currentDate = moment(); // Initialize with Moment.js object for current date

        // --- Auth Functions ---
        const openAuthModal = () => {
            authModal.classList.remove('hidden');
        };

        const closeAuthModal = () => {
            authModal.classList.add('hidden');
        };

        const openEmailAuthModal = (type) => {
            emailAuthModal.classList.remove('hidden');
            emailAuthTitle.textContent = type === 'login' ? 'Login' : 'Sign Up';
            emailAuthSubmit.textContent = type === 'login' ? 'Login' : 'Sign Up';
            emailAuthForm.dataset.type = type; // Store type for form submission
            closeAuthModal(); // Close the initial auth selection modal
        };

        const closeEmailAuthModalFunc = () => {
            emailAuthModal.classList.add('hidden');
            emailAuthForm.reset();
        };

        const updateAuthUI = (isLoggedIn) => {
            if (isLoggedIn) {
                heroSection.classList.add('hidden');
                tasksSection.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                getStartedBtn.classList.add('hidden');
                closeAuthModal();
                closeEmailAuthModalFunc();
                fetchTasks(currentDate.toDate()); // Pass Date object to fetchTasks
            } else {
                heroSection.classList.remove('hidden');
                tasksSection.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                getStartedBtn.classList.remove('hidden');
            }
        };

        // Event Listeners for Auth Modals
        loginBtn.addEventListener('click', () => openEmailAuthModal('login'));
        signupBtn.addEventListener('click', () => openEmailAuthModal('signup'));
        closeEmailAuthModal.addEventListener('click', closeEmailAuthModalFunc);

        emailAuthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const type = emailAuthForm.dataset.type;
            const endpoint = type === 'login' ? 'login' : 'register';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('isLoggedIn', 'true');
                    updateAuthUI(true);
                    alert(`Successfully ${type === 'login' ? 'logged in' : 'signed up'}!`);
                } else {
                    alert(`Error: ${data.message || 'Something went wrong.'}`);
                }
            } catch (error) {
                console.error('Auth error:', error);
                alert('An error occurred during authentication.');
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('isLoggedIn');
            updateAuthUI(false);
            alert('Logged out successfully!');
        });

        // --- Task Functions ---
        const fetchTasks = async (date) => {
            const token = localStorage.getItem('token');
            if (!token) return;

            // Use moment.js for consistent date handling
            const momDate = moment(date);
            const startOfDayUtc = momDate.startOf('day').toISOString();
            const endOfDayExclusiveUtc = momDate.endOf('day').toISOString(); // Use endOf to get up to midnight of that day

            tasksForDateEl.textContent = `Tasks for ${momDate.format('dddd, MMMM D, YYYY')}`;
            taskListEl.innerHTML = ''; // Clear previous tasks
            noTasksMessage.classList.add('hidden');

            try {
                const url = `${API_BASE_URL}/tasks?start=${encodeURIComponent(startOfDayUtc)}&end=${encodeURIComponent(endOfDayExclusiveUtc)}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const tasks = await response.json();

                if (response.ok) {
                    if (tasks.length === 0) {
                        noTasksMessage.classList.remove('hidden');
                    } else {
                        tasks.sort((a, b) => moment(a.dateTime).valueOf() - moment(b.dateTime).valueOf()); // Sort by time
                        tasks.forEach(task => {
                            const taskItem = document.createElement('div');
                            taskItem.className = 'bg-white p-4 rounded-lg shadow-md flex items-center justify-between';
                            const taskDateTime = moment(task.dateTime); // Use moment for display
                            taskItem.innerHTML = `
                                <div>
                                    <h5 class="font-semibold text-lg ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${task.description}</h5>
                                    <p class="text-sm text-gray-600">${taskDateTime.format('h:mm A')}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" data-id="${task._id}" ${task.completed ? 'checked' : ''} class="task-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <button data-id="${task._id}" class="edit-task-btn text-blue-500 hover:text-blue-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.586 3.586l-2.828 2.828-5.657 5.657a1 1 0 00.343 1.03l.911.911a1 1_ 0 001.03.343l5.657-5.657 2.828-2.828-2.828-2.828z" />
                                        </svg>
                                    </button>
                                    <button data-id="${task._id}" class="delete-task-btn text-red-500 hover:text-red-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 3a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            `;
                            taskListEl.appendChild(taskItem);
                        });
                    }
                    attachTaskEventListeners();
                } else {
                    console.error('Failed to fetch tasks:', tasks.message);
                    alert('Failed to load tasks. Please try again.');
                }
            } catch (error) {
                console.error('Error fetching tasks:', error);
                alert('An error occurred while fetching tasks.');
            }
        };

        const attachTaskEventListeners = () => {
            document.querySelectorAll('.delete-task-btn').forEach(button => {
                button.onclick = (e) => deleteTask(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.edit-task-btn').forEach(button => {
                button.onclick = (e) => editTask(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.onchange = (e) => toggleTaskCompleted(e.currentTarget.dataset.id, e.currentTarget.checked);
            });
        };

        const deleteTask = async (id) => {
            const token = localStorage.getItem('token');
            if (!confirm('Are you sure you want to delete this task?')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    alert('Task deleted successfully!');
                    fetchTasks(currentDate.toDate()); // Refresh tasks after deletion
                } else {
                    const data = await response.json();
                    alert(`Failed to delete task: ${data.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('An error occurred while deleting the task.');
            }
        };

        const editTask = async (id) => {
            const token = localStorage.getItem('token');
            const newDescription = prompt('Enter new description:');
            if (newDescription === null || newDescription.trim() === '') return;

            try {
                const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ description: newDescription })
                });
                if (response.ok) {
                    alert('Task updated successfully!');
                    fetchTasks(currentDate.toDate());
                } else {
                    const data = await response.json();
                    alert(`Failed to update task: ${data.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Error updating task:', error);
                alert('An error occurred while updating the task.');
            }
        };

        const toggleTaskCompleted = async (id, completed) => {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ completed })
                });
                if (response.ok) {
                    const taskItem = document.querySelector(`input[data-id="${id}"]`).closest('.flex.items-center.justify-between');
                    if (taskItem) {
                        const descriptionEl = taskItem.querySelector('h5');
                        if (completed) {
                            descriptionEl.classList.add('line-through', 'text-gray-500');
                            descriptionEl.classList.remove('text-gray-800');
                        } else {
                            descriptionEl.classList.remove('line-through', 'text-gray-500');
                            descriptionEl.classList.add('text-gray-800');
                        }
                    }
                } else {
                    const data = await response.json();
                    alert(`Failed to update task status: ${data.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Error toggling task completed status:', error);
                alert('An error occurred while updating the task status.');
            }
        };


        addTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = taskDescriptionInput.value;
            const dateTime = moment(taskDateTimeInput.value).toISOString(); // Use moment for consistent ISO string
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_BASE_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ description, dateTime })
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Task added successfully!');
                    taskDescriptionInput.value = '';
                    taskDateTimeInput.value = '';
                    fetchTasks(currentDate.toDate()); // Refresh tasks
                } else {
                    alert(`Error adding task: ${data.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Add task error:', error);
                alert('An error occurred while adding the task.');
            }
        });

        // --- Calendar Functions ---
        const renderCalendar = () => {
            calendarEl.innerHTML = `
                <div class="font-semibold text-gray-600">Sun</div>
                <div class="font-semibold text-gray-600">Mon</div>
                <div class="font-semibold text-gray-600">Tue</div>
                <div class="font-semibold text-gray-600">Wed</div>
                <div class="font-semibold text-gray-600">Thu</div>
                <div class="font-semibold text-gray-600">Fri</div>
                <div class="font-semibold text-gray-600">Sat</div>
            `; // Clear and re-add headers

            const year = currentDate.year();
            const month = currentDate.month();
            currentMonthYearEl.textContent = currentDate.format('MMMM YYYY');

            const firstDayOfMonth = moment(currentDate).startOf('month');
            const daysInMonth = currentDate.daysInMonth();

            // Add empty divs for the days before the 1st of the month
            for (let i = 0; i < firstDayOfMonth.day(); i++) {
                calendarEl.innerHTML += '<div></div>';
            }

            // Add days of the month
            const today = moment(); // Get today's date once
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.textContent = day;
                dayDiv.className = 'p-2 cursor-pointer hover:bg-gray-200 rounded-full flex items-center justify-center';
                dayDiv.dataset.day = day;

                const fullDate = moment({ year: year, month: month, day: day });

                // Add 'today-day' class if it's today's date
                if (fullDate.isSame(today, 'day')) {
                    dayDiv.classList.add('today-day');
                }

                // Add 'active-day' class if it's the currently selected date
                if (fullDate.isSame(currentDate, 'day')) {
                    dayDiv.classList.add('active-day');
                }

                dayDiv.addEventListener('click', () => {
                    currentDate.date(parseInt(dayDiv.dataset.day));
                    renderCalendar(); // Re-render to update active day class
                    fetchTasks(currentDate.toDate()); // Fetch tasks for the selected day
                });
                calendarEl.appendChild(dayDiv);
            }
        };

        prevMonthBtn.addEventListener('click', () => {
            currentDate.subtract(1, 'month');
            renderCalendar();
            fetchTasks(currentDate.toDate());
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.add(1, 'month');
            renderCalendar();
            fetchTasks(currentDate.toDate());
        });

        // --- AI Voice Assistant Logic ---
        if ('speechSynthesis' in window && 'SpeechRecognition' in window) {
            const voiceAssistantBtn = document.getElementById('voiceAssistantBtn');
            const assistantStatus = document.getElementById('assistantStatus');
            const messageModal = document.getElementById('messageModal');
            const modalMessage = document.getElementById('modalMessage');
            const modalHeader = document.getElementById('modalHeader');
            const modalCloseButton = document.getElementById('modalCloseButton');


            let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const synth = window.speechSynthesis;

            voiceAssistantBtn.addEventListener('click', () => {
                setStatus('Listening...', false);
                assistantStatus.classList.remove('hidden');
                recognition.start();
            });

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript.toLowerCase();
                setStatus(`Heard: "${speechResult}"`, false);
                processCommand(speechResult);
            };

            recognition.onerror = (event) => {
                setStatus(`Speech recognition error: ${event.error}`, true);
                console.error('Speech recognition error:', event.error);
                 assistantStatus.classList.remove('hidden');
                 setTimeout(() => assistantStatus.classList.add('hidden'), 3000);
            };

            recognition.onend = () => {
                if (!assistantStatus.classList.contains('text-red-500')) {
                     setTimeout(() => assistantStatus.classList.add('hidden'), 1500);
                }
            };

            const speak = (text) => {
                const utterance = new SpeechSynthesisUtterance(text);
                synth.speak(utterance);
            };

            const setStatus = (message, isError = false) => {
                assistantStatus.textContent = message;
                assistantStatus.className = `fixed bottom-20 right-20 bg-white p-2 rounded shadow-lg text-sm ${isError ? 'text-red-500' : 'text-gray-600'} z-50`;
            };

            const showModalMessage = (message, type = 'info') => {
                if (!messageModal || !modalMessage || !modalHeader || !modalCloseButton) {
                    console.warn("Message modal elements not found, falling back to alert.");
                    alert(message);
                    return;
                }

                modalMessage.textContent = message;
                modalHeader.className = `p-4 rounded-t-lg ${type === 'error' ? 'bg-red-500' : 'bg-blue-500'} text-white`;
                messageModal.classList.remove('hidden');

                modalCloseButton.onclick = () => {
                    messageModal.classList.add('hidden');
                };
                messageModal.querySelector('.modal-overlay').onclick = (e) => {
                    if (e.target.classList.contains('modal-overlay')) {
                        messageModal.classList.add('hidden');
                    }
                };
            };

            // Enhanced parseNaturalDateTime using Moment.js
            const parseNaturalDateTime = (text) => {
                let m = moment(); // Start with current moment

                // Try to parse direct dates first (e.g., "July 20th", "2025-07-20")
                let parsedMoment = moment(text);
                if (parsedMoment.isValid()) {
                    return parsedMoment; // If a full date is recognized
                }

                // Relative dates
                if (text.includes('today')) {
                    m = moment();
                } else if (text.includes('tomorrow')) {
                    m.add(1, 'day');
                } else if (text.includes('day after tomorrow')) {
                    m.add(2, 'days');
                } else if (text.includes('next week')) {
                    m.add(1, 'week');
                } else if (text.includes('next month')) {
                    m.add(1, 'month');
                } else {
                    const dayKeywords = {
                        'sunday': 0, 'monday': 1, 'tuesday': 2, 'wednesday': 3,
                        'thursday': 4, 'friday': 5, 'saturday': 6
                    };
                    for (const dayName in dayKeywords) {
                        if (text.includes(dayName)) {
                            let targetDay = dayKeywords[dayName];
                            m.day(targetDay);
                            // If the parsed day is in the past, move to next week
                            if (m.isBefore(moment(), 'day') && !text.includes('last')) {
                                m.add(1, 'week');
                            }
                            break;
                        }
                    }
                }

                // Relative times (must be applied after date parsing)
                if (text.includes('morning')) {
                    m.hour(9).minute(0).second(0);
                } else if (text.includes('afternoon')) {
                    m.hour(14).minute(0).second(0); // 2 PM
                } else if (text.includes('evening')) {
                    m.hour(18).minute(0).second(0); // 6 PM
                } else if (text.includes('night')) {
                    m.hour(21).minute(0).second(0); // 9 PM
                }

                // Specific time parsing (e.g., "3 PM", "10 o'clock", "14:00", "in X minutes/hours")
                let timeMatch = text.match(/(\d{1,2}(?::\d{2})?\s*(?:am|pm|o'clock)?)|(?:in\s+(\d+)\s+(?:minute|minutes|hour|hours))/i);
                if (timeMatch) {
                    if (timeMatch[1]) { // e.g., "3 PM", "10:30", "10 o'clock"
                        let timeStr = timeMatch[1].toLowerCase();
                        let tempMoment = moment(timeStr, ["h A", "H:mm", "h o'clock"]);
                        if (tempMoment.isValid()) {
                            m.hour(tempMoment.hour()).minute(tempMoment.minute()).second(0);
                        }
                    } else if (timeMatch[2] && text.includes('minute')) { // e.g., "in 15 minutes"
                        m.add(parseInt(timeMatch[2]), 'minutes');
                    } else if (timeMatch[2] && text.includes('hour')) { // e.g., "in 2 hours"
                        m.add(parseInt(timeMatch[2]), 'hours');
                    }
                }

                // If no time was specifically mentioned, and it's a future day, default to 9 AM
                // If it's today and no time, default to the next full hour
                if (!timeMatch && m.isSame(moment(), 'day')) {
                    m.add(1, 'hour').startOf('hour'); // Next full hour
                } else if (!timeMatch && m.isAfter(moment(), 'day')) {
                    m.hour(9).minute(0).second(0); // Default to 9 AM for future dates
                }
                
                // Ensure the resulting moment is valid and not in the past relative to current time if a future command
                if (m.isBefore(moment()) && !text.includes('past')) { // Avoid moving to future if explicitly talking about past
                    // If a specific time was mentioned but it's now in the past today, assume next day.
                    // This is a common desired behavior for "do X at 9 PM" when it's already 10 PM.
                    if (timeMatch && m.isSame(moment(), 'day')) {
                         m.add(1, 'day');
                    }
                }

                return m;
            };

            const processCommand = async (command) => {
                let responseText = "I didn't understand that. Can you please rephrase?";
                let actionPerformed = false;

                // Basic greetings and info
                if (command.includes('hello') || command.includes('hi')) {
                    responseText = "Hello there! How can I help you today?";
                    actionPerformed = true;
                } else if (command.includes('what can you do')) {
                    responseText = "I can help you add tasks, show your schedule, mark tasks as complete, or delete tasks. Just tell me what you need!";
                    actionPerformed = true;
                } else if (command.includes('goodbye') || command.includes('bye')) {
                    responseText = "Goodbye! Have a great day.";
                    actionPerformed = true;
                }
                // Add Task
                else if (command.includes('add a task') || command.includes('create a task') || command.includes('add task') || command.includes('create task') || command.includes('schedule')) {
                    // Broader regex to capture description and optional date/time phrase
                    const taskRegex = /(?:add a task|create a task|add task|create task|schedule)\s+(?:to\s+)?(.+?)(?:\s+(?:on|for|at|by|next|this|in)\s+(.+))?$/i;
                    const match = command.match(taskRegex);

                    if (match && match[1]) {
                        const description = match[1].trim();
                        let dateTimePhrase = match[2] ? match[2].trim() : '';
                        
                        let taskMoment;
                        if (dateTimePhrase) {
                            taskMoment = parseNaturalDateTime(dateTimePhrase);
                        } else {
                            // If no date/time specified, default to tomorrow 9 AM
                            taskMoment = moment().add(1, 'day').hour(9).minute(0).second(0);
                        }

                        if (!taskMoment.isValid()) {
                            responseText = "I couldn't understand the date and time for that task. Please try again with a clearer date or time.";
                            actionPerformed = true;
                        } else {
                            const dateTime = taskMoment.toISOString();
                            try {
                                const token = localStorage.getItem('token');
                                if (!token) {
                                    responseText = "You need to be logged in to add tasks.";
                                    showModalMessage(responseText, 'error');
                                    actionPerformed = true;
                                    return;
                                }
                                const response = await fetch(`${API_BASE_URL}/tasks`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify({ description, dateTime })
                                });
                                const data = await response.json();
                                if (response.ok) {
                                    responseText = `Task "${data.description}" added for ${moment(data.dateTime).format('h:mm A on MMMM D')}.`;
                                    fetchTasks(currentDate.toDate()); // Refresh calendar tasks for the current view
                                } else {
                                    responseText = `Failed to add task: ${data.message || response.statusText}.`;
                                }
                            } catch (error) {
                                console.error('Error adding task:', error);
                                responseText = `An error occurred while adding the task. Please try again.`;
                            }
                            actionPerformed = true;
                        }
                    } else {
                        responseText = "I couldn't understand the task details. Please say something like 'add a task to call John tomorrow at 3 PM'.";
                        actionPerformed = true;
                    }
                }
                // Suggest Task Time - (Currently relies on backend AI, just updating wording)
                else if (command.includes('suggest a time for')) {
                    const suggestRegex = /(?:suggest a time for)\s+(.+)$/i;
                    const match = command.match(suggestRegex);

                    if (match && match[1]) {
                        const description = match[1].trim();
                        try {
                            const token = localStorage.getItem('token');
                            if (!token) {
                                responseText = "You need to be logged in to get task suggestions.";
                                showModalMessage(responseText, 'error');
                                actionPerformed = true;
                                return;
                            }
                            const response = await fetch(`${API_BASE_URL}/tasks/suggest-time`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ description })
                            });
                            const data = await response.json();
                            if (response.ok) {
                                responseText = data.message; // Backend provides the suggestion
                            } else {
                                responseText = `Failed to get suggestion: ${data.message || response.statusText}.`;
                            }
                        } catch (error) {
                            console.error('Error getting AI suggestion:', error);
                            responseText = `An error occurred while getting a suggestion. Please try again.`;
                        }
                        actionPerformed = true;
                    } else {
                        responseText = "I couldn't understand the task description for suggestion. Please say something like 'suggest a time for meeting with team'.";
                        actionPerformed = true;
                    }
                }
                // Fetch Tasks for a specific Date (Show Schedule)
                else if (command.includes('show tasks for') || command.includes('my schedule for') || command.includes('what do i have')) {
                    let datePhrase = command.replace(/(show tasks for|my schedule for|what do i have)/i, '').trim();
                    if (!datePhrase || datePhrase.includes('today')) {
                        datePhrase = 'today';
                    } else if (datePhrase.includes('tomorrow')) {
                        datePhrase = 'tomorrow';
                    }

                    const targetMoment = parseNaturalDateTime(datePhrase);

                    if (targetMoment.isValid()) {
                        currentDate = targetMoment; // Update the calendar's current date Moment object
                        renderCalendar(); // Re-render calendar to highlight new date
                        await fetchTasks(currentDate.toDate()); // Fetch tasks for the new date
                        responseText = `Showing tasks for ${currentDate.format('dddd, MMMM D')}.`;
                    } else {
                        responseText = "I couldn't understand the date. Please specify a valid date like 'show tasks for today' or 'show tasks for next Tuesday'.";
                    }
                    actionPerformed = true;
                }
                // Mark Task Complete/Incomplete
                else if (command.includes('mark') && (command.includes('complete') || command.includes('done') || command.includes('incomplete') || command.includes('not done'))) {
                    const completeRegex = /(?:mark|set) (.+?) as (complete|done|incomplete|not done)/i;
                    const match = command.match(completeRegex);
                    if (match && match[1]) {
                        const descriptionPart = match[1].trim();
                        const statusPart = match[2].toLowerCase();
                        const completed = (statusPart === 'complete' || statusPart === 'done');

                        // Find the task on the currently displayed date
                        const currentTasks = Array.from(taskListEl.children)
                                            .filter(el => el.classList.contains('bg-white'))
                                            .map(el => ({
                                                id: el.querySelector('.task-checkbox').dataset.id,
                                                description: el.querySelector('h5').textContent.toLowerCase(),
                                                completed: el.querySelector('.task-checkbox').checked
                                            }));

                        const foundTask = currentTasks.find(task => task.description.includes(descriptionPart));

                        if (foundTask) {
                            await toggleTaskCompleted(foundTask.id, completed);
                            responseText = `Task "${foundTask.description}" marked as ${completed ? 'complete' : 'incomplete'}.`;
                            fetchTasks(currentDate.toDate()); // Re-fetch to ensure UI consistency
                        } else {
                            responseText = `I couldn't find a task matching "${descriptionPart}" for ${currentDate.format('MMMM D')}.`;
                        }
                        actionPerformed = true;
                    } else {
                        responseText = "Please tell me which task to mark, like 'mark send email as complete'.";
                        actionPerformed = true;
                    }
                }
                // Delete Task
                else if (command.includes('delete task') || command.includes('remove task')) {
                    const deleteRegex = /(?:delete|remove) task(?: about)?\s+(.+)/i;
                    const match = command.match(deleteRegex);
                    if (match && match[1]) {
                        const descriptionPart = match[1].trim();

                        // Find the task on the currently displayed date
                        const currentTasks = Array.from(taskListEl.children)
                                            .filter(el => el.classList.contains('bg-white'))
                                            .map(el => ({
                                                id: el.querySelector('.task-checkbox').dataset.id,
                                                description: el.querySelector('h5').textContent.toLowerCase()
                                            }));

                        const foundTask = currentTasks.find(task => task.description.includes(descriptionPart));

                        if (foundTask) {
                            if (confirm(`Are you sure you want to delete "${foundTask.description}"?`)) {
                                await deleteTask(foundTask.id);
                                responseText = `Task "${foundTask.description}" has been deleted.`;
                                fetchTasks(currentDate.toDate()); // Re-fetch to update UI
                            } else {
                                responseText = "Deletion cancelled.";
                            }
                        } else {
                            responseText = `I couldn't find a task matching "${descriptionPart}" for ${currentDate.format('MMMM D')}.`;
                        }
                        actionPerformed = true;
                    } else {
                        responseText = "Please tell me which task to delete, like 'delete task call John'.";
                        actionPerformed = true;
                    }
                }


                if (!actionPerformed) {
                    speak(responseText);
                    setStatus(responseText);
                } else {
                    speak(responseText);
                    setStatus(responseText);
                    if (responseText.includes("Failed") || responseText.includes("error occurred") || responseText.includes("need to be logged in") || responseText.includes("couldn't understand")) {
                         showModalMessage(responseText, 'error');
                    } else {
                        showModalMessage(responseText);
                    }
                }
            };

            window.speak = speak;
        } else {
            // Browser does not support Web Speech API
            voiceAssistantBtn.style.display = 'none';
            assistantStatus.style.display = 'none';
            showModalMessage('Voice assistant not supported in this browser. Please use Chrome or Edge.', 'error');
        }
        // --- End AI Voice Assistant Logic ---


        // Initial Render calls
        renderCalendar();
        // Check login status on page load
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        updateAuthUI(isLoggedIn); // Update UI based on initial login status

        // Event listener for "Get Started" button to open auth modal or go to tasks
        if (getStartedBtn) {
            getStartedBtn.addEventListener('click', () => {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                if (isLoggedIn) {
                    window.location.href = '#tasks'; // If already logged in, redirect to tasks section
                } else {
                    openAuthModal(); // If not logged in, open the auth modal
                }
            });
        }

    }); // End DOMContentLoaded
</script>
</body>
</html>
