<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="Calndo - AI-powered calendar for seamless task and event scheduling." name="description"/>
<meta content="AI calendar, task scheduling, event planning, productivity" name="keywords"/>
<meta content="Calndo" name="author"/>
<title>Calndo - AI-Powered Scheduling</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #4FD1C5, #4299E1); }
        .fab { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .header-transparent { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: #eee;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        .tab-button.active {
            background-color: #fff;
            border-bottom: 2px solid #4FD1C5;
            color: #4FD1C5;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        /* Style for hidden search input */
        .hidden-search-input {
            width: 0;
            opacity: 0;
            transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out;
            padding: 0;
        }
        .visible-search-input {
            width: 100%;
            opacity: 1;
            padding: 12px; /* Restore padding when visible */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<header class="header-transparent absolute top-0 left-0 w-full z-10 p-6">
    <nav class="container mx-auto flex justify-between items-center">
        <a href="#" class="text-2xl font-bold text-teal-600">Calndo</a>
        <div class="space-x-4">
            <a href="#features" class="text-gray-700 hover:text-teal-600 transition duration-300">Features</a>
            <a href="#about" class="text-gray-700 hover:text-teal-600 transition duration-300">About</a>
            <a href="#contact" class="text-gray-700 hover:text-teal-600 transition duration-300">Contact</a>
            <button id="authModalBtn" class="bg-teal-600 text-white px-5 py-2 rounded-full hover:bg-teal-700 transition duration-300">Sign Up / Login</button>
            <button id="logoutBtn" class="bg-red-500 text-white px-5 py-2 rounded-full hover:bg-red-600 transition duration-300 hidden">Logout</button>
        </div>
    </nav>
</header>

<section id="hero" class="gradient-bg text-white py-24 md:py-32 flex items-center min-h-screen relative overflow-hidden">
    <div class="container mx-auto text-center z-10" data-aos="fade-up" data-aos-duration="1000">
        <h1 class="text-4xl md:text-6xl font-extrabold leading-tight mb-6">Your Day, Perfected by AI.</h1>
        <p class="text-xl md:text-2xl mb-10 max-w-2xl mx-auto">Calndo intelligently schedules your tasks and events for ultimate productivity.</p>
        <button id="getStartedBtn" class="bg-white text-teal-600 px-8 py-3 rounded-full text-lg font-semibold hover:bg-gray-100 transition duration-300 shadow-lg">Get Started</button>
    </div>
    <div class="absolute inset-0 z-0 opacity-20">
        <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice">
            <defs>
                <radialGradient id="grad1" cx="50%" cy="50%" r="50%">
                    <stop offset="0%" stop-color="#4FD1C5" stop-opacity="0.8"/>
                    <stop offset="100%" stop-color="#4299E1" stop-opacity="0"/>
                </radialGradient>
            </defs>
            <circle cx="20" cy="80" r="30" fill="url(#grad1)"/>
            <circle cx="80" cy="20" r="40" fill="url(#grad1)"/>
            <circle cx="50" cy="50" r="25" fill="url(#grad1)"/>
        </svg>
    </div>
</section>

<section id="features" class="py-16 md:py-24 bg-white">
    <div class="container mx-auto text-center" data-aos="fade-up" data-aos-duration="1000">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-12">Unleash Your Productivity</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 px-4">
            <div class="p-6 rounded-lg shadow-md bg-white hover:shadow-xl transition duration-300">
                <div class="text-teal-500 mb-4 text-4xl">üóìÔ∏è</div>
                <h3 class="text-xl font-semibold mb-2">Smart Scheduling</h3>
                <p class="text-gray-600">AI optimizes your calendar, finding the best slots for your tasks.</p>
            </div>
            <div class="p-6 rounded-lg shadow-md bg-white hover:shadow-xl transition duration-300">
                <div class="text-teal-500 mb-4 text-4xl">‚úçÔ∏è</div>
                <h3 class="text-xl font-semibold mb-2">Effortless Task Management</h3>
                <p class="text-gray-600">Add, track, and complete tasks with an intuitive interface.</p>
            </div>
            <div class="p-6 rounded-lg shadow-md bg-white hover:shadow-xl transition duration-300">
                <div class="text-teal-500 mb-4 text-4xl">üó£Ô∏è</div>
                <h3 class="text-xl font-semibold mb-2">Voice Assistant</h3>
                <p class="text-gray-600">Manage your schedule hands-free with simple voice commands.</p>
            </div>
        </div>
    </div>
</section>

<section id="tasks" class="py-16 md:py-24 bg-gray-100 hidden" data-aos="fade-up" data-aos-duration="1000">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-12">Your Personalized Calendar</h2>

        <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Previous</button>
            <h3 id="currentMonthYear" class="text-2xl font-semibold"></h3>
            <button id="nextMonth" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Next</button>
        </div>

        <div id="calendar" class="grid grid-cols-7 gap-1 bg-white rounded-lg shadow-md p-4">
            </div>

        <div class="mt-12 p-6 bg-white rounded-lg shadow-md">
            <h3 class="text-2xl font-semibold mb-6">Tasks for <span id="selectedDateDisplay"></span></h3>
            <p id="taskStatus" class="text-center text-gray-600 my-4 hidden"></p>

            <div class="mb-6 flex items-center space-x-2">
                <button id="toggleSearchBtn" class="p-2 text-gray-600 hover:text-teal-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
                <input type="text" id="taskSearchInput" placeholder="Search tasks..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 hidden-search-input"/>
            </div>

            <form id="taskForm" class="mb-8 flex flex-col md:flex-row gap-4">
                <input type="text" id="taskInput" placeholder="New task description" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
                <label for="taskDateTime" class="block text-sm font-medium text-gray-700">Task Date & Time:</label>
                <input type="datetime-local" id="taskDateTime" class="border p-2 rounded w-full mb-2" required>
                <button type="submit" class="bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition duration-300">Add Task</button>
            </form>

            <div class="mb-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h4 class="text-lg font-semibold text-blue-800 mb-2">AI Task Scheduling Assistant</h4>
                <p class="text-blue-700 mb-4">Let AI suggest an optimal time for your task.</p>
                <input type="text" id="aiTaskInput" placeholder="Task for AI suggestion (e.g., 'Meeting with John')" class="w-full p-3 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3"/>
                <button id="suggestTimeBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300">Suggest Time</button>
                <p id="aiSuggestionOutput" class="mt-4 text-blue-900 font-medium hidden"></p>
            </div>

            <div id="taskList" class="space-y-4">
                <p class="text-gray-500 text-center" id="noTasksMessage">No tasks for this day. Add a new one!</p>
            </div>
        </div>
        <button id="voiceAssistantBtn" class="fab bg-purple-600 text-white p-4 rounded-full shadow-lg hover:bg-purple-700 transition duration-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m7 0V5a2 2 0 012-2h2a2 2 0 012 2v6m-6 0H6.5M10 21v-5a2 2 0 00-2-2H6a2 2 0 00-2 2v5m8 0h3.5" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>
        </button>
        <p id="voiceAssistantStatus" class="fixed bottom-20 right-20 text-sm text-gray-700 bg-white p-2 rounded-lg shadow hidden z-1001"></p>

    </div>
</section>


<section id="about" class="py-16 md:py-24 bg-white">
    <div class="container mx-auto px-4 text-center" data-aos="fade-up" data-aos-duration="1000">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-8">About Calndo</h2>
        <p class="text-lg text-gray-600 max-w-3xl mx-auto leading-relaxed">
            Calndo is your intelligent partner in time management. Leveraging cutting-edge AI, we
            transform the way you organize your day. From suggesting optimal task timings to
            providing a hands-free voice assistant, Calndo is built to boost your productivity
            and help you achieve your goals effortlessly. We believe in making scheduling
            smart, simple, and seamless.
        </p>
    </div>
</section>

<section id="contact" class="py-16 md:py-24 gradient-bg text-white">
    <div class="container mx-auto px-4 text-center" data-aos="fade-up" data-aos-duration="1000">
        <h2 class="text-3xl md:text-4xl font-bold mb-8">Get In Touch</h2>
        <p class="text-lg mb-8 max-w-xl mx-auto">Have questions or feedback? We'd love to hear from you!</p>
        <form class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl" id="contactForm">
            <input type="text" id="contactName" placeholder="Your Name" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-800"/>
            <input type="email" id="contactEmail" placeholder="Your Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-800"/>
            <textarea id="contactMessage" rows="5" placeholder="Your Message" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-800"></textarea>
            <button type="submit" class="bg-teal-600 text-white px-8 py-3 rounded-full hover:bg-teal-700 transition duration-300 font-semibold">Send Message</button>
        </form>
        <p id="contactStatus" class="mt-4 text-white font-medium hidden"></p>
    </div>
</section>

<footer class="bg-gray-800 text-white py-8 text-center">
    <div class="container mx-auto px-4">
        <p>&copy; 2025 Calndo. All rights reserved.</p>
        <div class="mt-4 space-x-4">
            <a href="#" class="text-gray-400 hover:text-white">Privacy Policy</a>
            <a href="#" class="text-gray-400 hover:text-white">Terms of Service</a>
        </div>
    </div>
</footer>

<div id="authModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeAuthModal()">&times;</span>
        <div class="flex justify-center mb-4">
            <button id="loginTab" class="tab-button active">Login</button>
            <button id="signupTab" class="tab-button">Sign Up</button>
        </div>

        <div id="loginContent" class="tab-content active">
            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
                <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
                <button type="submit" class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition duration-300">Login</button>
                <p id="loginStatus" class="text-center text-red-500 mt-2 hidden"></p>
            </form>
        </div>

        <div id="signupContent" class="tab-content">
            <form id="signupForm" class="space-y-4">
                <input type="email" id="signupEmail" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
                <input type="password" id="signupPassword" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
                <button type="submit" class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition duration-300">Sign Up</button>
                <p id="signupStatus" class="text-center text-red-500 mt-2 hidden"></p>
            </form>
        </div>
    </div>
</div>

<div id="editTaskModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeEditTaskModal()">&times;</span>
        <h3 class="text-xl font-semibold mb-4">Edit Task</h3>
        <form id="editTaskForm" class="space-y-4">
            <input type="hidden" id="editTaskId"/>
            <label for="editTaskDescription" class="block text-gray-700">Description:</label>
            <input type="text" id="editTaskDescription" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
            <label for="editTaskDateTime" class="block text-gray-700">Date & Time:</label>
            <input type="datetime-local" id="editTaskDateTime" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"/>
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="editTaskCompleted" class="form-checkbox h-5 w-5 text-teal-600"/>
                <label for="editTaskCompleted" class="text-gray-700">Completed</label>
            </div>
            <button type="submit" class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 transition duration-300">Save Changes</button>
            <p id="editTaskStatus" class="text-center text-red-500 mt-2 hidden"></p>
        </form>
    </div>
</div>


<script>
    // Define API_BASE_URL globally
    const API_BASE_URL = 'https://backend-uuqk.onrender.com/api';

    // Utility function to set general status messages (e.g., success/error)
    function setStatus(message, isError) {
        const statusDiv = document.getElementById('status-message'); // Ensure you have an element with this ID
        if (statusDiv) {
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'text-red-500 font-bold' : 'text-green-500';
        }
    }

    // Voice synthesis setup
    const synth = window.speechSynthesis;
    let currentUtterance = null;
    function speak(text) {
        if (synth.speaking) {
            synth.cancel();
        }
        currentUtterance = new SpeechSynthesisUtterance(text);
        currentUtterance.lang = 'en-US';
        synth.speak(currentUtterance);
    }

    // Assistant status display
    function setAssistantStatus(message) {
        const statusElement = document.getElementById('assistantStatus'); // Ensure you have an element with this ID
        if (statusElement) {
            statusElement.textContent = message;
        }
    }

    // Modal functions: open and close any modal element
    function openModal(modalElement) {
        if (modalElement) {
            modalElement.classList.remove('hidden');
            const overlay = document.getElementById('modal-backdrop'); // Assuming you have a full-screen modal backdrop
            if (overlay) overlay.classList.remove('hidden');
        }
    }

    function closeModal(modalElement) {
        if (modalElement) {
            modalElement.classList.add('hidden');
            const overlay = document.getElementById('modal-backdrop'); // Assuming you have a full-screen modal backdrop
            if (overlay) overlay.classList.add('hidden');
        }
    }

    // Function to clear authentication specific error messages
    function clearAuthErrors() {
        const authErrorElement = document.getElementById('authError'); // Ensure you have an element with this ID
        if (authErrorElement) {
            authErrorElement.textContent = '';
        }
    }

    // AI Natural Language Date/Time Parser
    // This function attempts to parse human-readable date/time strings
    const parseNaturalDateTime = (inputString) => {
        let date = new Date(); // Start with current date
        let timePart = '';
        let dayOffset = 0; // 0 for today, 1 for tomorrow

        // Handle "tomorrow"
        const tomorrowMatch = inputString.match(/tomorrow(?: at (.+))?/i);
        if (tomorrowMatch) {
            dayOffset = 1;
            timePart = tomorrowMatch[1] || ''; // Capture time part if present
            inputString = inputString.replace(tomorrowMatch[0], '').trim(); // Remove "tomorrow" from string
        }
        // Handle "today"
        else if (inputString.includes('today')) {
            dayOffset = 0; // Already today
            const todayMatch = inputString.match(/today(?: at (.+))?/i);
            timePart = todayMatch ? todayMatch[1] : '';
            inputString = inputString.replace(todayMatch[0], '').trim(); // Remove "today" from string
        }

        // Try to find a standalone time like "5pm", "5:00 pm", etc.
        const timeOnlyRegex = /(?:at|by|for)?\s*(\d{1,2}(?::\d{2})?\s*(?:am|pm)?)\b/i; // \b for word boundary
        const timeOnlyMatch = inputString.match(timeOnlyRegex);
        if (timeOnlyMatch) {
            timePart = timeOnlyMatch[1];
            inputString = inputString.replace(timeOnlyMatch[0], '').trim(); // Remove time part from inputString
        }

        // Apply day offset first
        date.setDate(date.getDate() + dayOffset);

        // Try parsing the remaining input string as a date.
        // If inputString is now just description, new Date(inputString) will be Invalid Date, which is fine.
        const potentialDate = new Date(inputString);
        if (!isNaN(potentialDate.getTime())) {
            // Only use the date part from potentialDate if it's a valid parsed date
            // and if a relative day (today/tomorrow) wasn't specified explicitly.
            if (dayOffset === 0 && !inputString.includes('today') && !inputString.includes('tomorrow')) {
                date.setFullYear(potentialDate.getFullYear(), potentialDate.getMonth(), potentialDate.getDate());
            }
        }

        if (timePart) {
            // Basic time parsing
            let hours = 0;
            let minutes = 0;
            const parsedTimeMatch = timePart.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
            if (parsedTimeMatch) {
                hours = parseInt(parsedTimeMatch[1], 10);
                minutes = parseInt(parsedTimeMatch[2] || '0', 10);
                const ampm = parsedTimeMatch[3] ? parsedTimeMatch[3].toLowerCase() : '';

                if (ampm === 'pm' && hours < 12) {
                    hours += 12;
                } else if (ampm === 'am' && hours === 12) { // 12 AM (midnight) is 0 hours
                    hours = 0;
                }
            }
            date.setHours(hours, minutes, 0, 0); // Set time
        } else {
            // If no time was specified, default to 9 AM
            date.setHours(9, 0, 0, 0);
        }

        return date; // Return the constructed date object
    };

    // Placeholder for renderCalendar function (implement your calendar rendering here)
    function renderCalendar() {
        console.log("renderCalendar function called (placeholder). Implement your calendar rendering here.");
        const calendarDiv = document.getElementById('calendar'); // Assuming a calendar div
        if (calendarDiv) {
            calendarDiv.innerHTML = '<h2>Calendar View (placeholder)</h2><p>Your calendar content will go here.</p>';
        }
    }

    // Function to fetch and display tasks
    async function fetchTasks() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('Not logged in, cannot fetch tasks.');
                const taskList = document.getElementById('task-list');
                if (taskList) taskList.innerHTML = '<p>Please log in to view your tasks.</p>';
                return;
            }

            // Determine the date to fetch tasks for (e.g., today's date in YYYY-MM-DD format)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            const response = await fetch(`${API_BASE_URL}/tasks?date=${formattedDate}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const tasks = await response.json();
            const taskList = document.getElementById('task-list'); // Ensure you have an element with this ID
            if (taskList) {
                taskList.innerHTML = ''; // Clear existing tasks
                if (tasks.length === 0) {
                    taskList.innerHTML = '<p>No tasks for today.</p>';
                    return;
                }
                tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'bg-white p-4 rounded-lg shadow-sm mb-2';
                    const taskDate = new Date(task.dateTime); // Ensure it's a Date object
                    taskItem.innerHTML = `
                        <h3 class="font-semibold">${task.description}</h3>
                        <p class="text-gray-600 text-sm">${taskDate.toLocaleString()}</p>
                        <p class="text-gray-500 text-xs">Status: ${task.completed ? 'Completed' : 'Pending'}</p>
                        `;
                    taskList.appendChild(taskItem);
                });
            }
        } catch (error) {
            console.error('Error fetching tasks:', error);
            setStatus(`Error fetching tasks: ${error.message}`, true);
        }
    }

    // Function to update UI elements based on authentication status
    function updateAuthUI(isLoggedIn) {
        const landingSection = document.getElementById('landing-section'); // Assuming this ID
        const tasksSection = document.getElementById('tasks-section'); // Assuming this ID
        const loginBtn = document.getElementById('login-btn'); // Assuming this ID
        const registerBtn = document.getElementById('register-btn'); // Assuming this ID
        const logoutBtn = document.getElementById('logout-btn'); // Assuming this ID

        if (isLoggedIn) {
            if (landingSection) landingSection.classList.add('hidden');
            if (tasksSection) tasksSection.classList.remove('hidden');
            if (loginBtn) loginBtn.classList.add('hidden');
            if (registerBtn) registerBtn.classList.add('hidden');
            if (logoutBtn) logoutBtn.classList.remove('hidden');
            fetchTasks(); // Fetch tasks only if logged in
        } else {
            if (landingSection) landingSection.classList.remove('hidden');
            if (tasksSection) tasksSection.classList.add('hidden');
            if (loginBtn) loginBtn.classList.remove('hidden');
            if (registerBtn) registerBtn.classList.remove('hidden');
            if (logoutBtn) logoutBtn.classList.add('hidden');
        }
    }

    // Login form submission handler
    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value; // Assuming this ID
        const password = document.getElementById('login-password').value; // Assuming this ID
        clearAuthErrors();

        try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || 'Login failed');
            }
            localStorage.setItem('token', data.token);
            localStorage.setItem('isLoggedIn', 'true');
            setStatus('Login successful!', false);
            closeModal(document.getElementById('authModal')); // Close auth modal after successful login
            updateAuthUI(true); // Update UI to logged-in state
        } catch (error) {
            document.getElementById('authError').textContent = error.message; // Display auth error
            setStatus(`Login failed: ${error.message}`, true);
        }
    }

    // Register form submission handler
    async function handleRegister(e) {
        e.preventDefault();
        const email = document.getElementById('register-email').value; // Assuming this ID
        const password = document.getElementById('register-password').value; // Assuming this ID
        clearAuthErrors();

        try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || 'Registration failed');
            }
            setStatus('Registration successful! Please log in.', false);
            document.getElementById('login-link').click(); // Automatically switch to login form
        } catch (error) {
            document.getElementById('authError').textContent = error.message; // Display auth error
            setStatus(`Registration failed: ${error.message}`, true);
        }
    }

    // --- Main DOMContentLoaded Listener ---
    // All DOM element selections and event listeners should be inside this to ensure elements exist
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element Selections (Ensure these IDs match your HTML) ---
        const statusMessage = document.getElementById('status-message');
        const assistantStatus = document.getElementById('assistantStatus');

        const getStartedBtn = document.getElementById('get-started-btn');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const authModal = document.getElementById('authModal');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginToggleBtn = document.getElementById('login-link');
        const registerToggleBtn = document.getElementById('register-link');
        const authError = document.getElementById('authError');

        const taskInput = document.getElementById('taskInput');
        const taskDateTimeInput = document.getElementById('taskDateTimeInput');
        const taskForm = document.getElementById('taskForm');
        const taskModal = document.getElementById('taskModal'); // <<< IMPORTANT: taskModal defined here
        const taskModalCloseBtn = document.getElementById('taskModalCloseBtn');

        const voiceAssistantBtn = document.getElementById('voiceAssistantBtn');

        const landingSection = document.getElementById('landing-section');
        const tasksSection = document.getElementById('tasks-section');
        const calendarSection = document.getElementById('calendar-section'); // Assuming this element exists in your HTML

        // --- Event Listeners ---

        // Authentication Modal Toggles (Login/Register link clicks)
        if (loginToggleBtn) {
            loginToggleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                clearAuthErrors(); // Clear errors when switching forms
            });
        }

        if (registerToggleBtn) {
            registerToggleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
                clearAuthErrors(); // Clear errors when switching forms
            });
        }

        // Login/Register Form Submissions
        if (loginForm) loginForm.addEventListener('submit', handleLogin);
        if (registerForm) registerForm.addEventListener('submit', handleRegister);

        // Logout Button
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('token'); // Clear token
                localStorage.setItem('isLoggedIn', 'false'); // Update login status
                setStatus('Logged out successfully!', false);
                updateAuthUI(false); // Update UI to logged-out state
                window.location.hash = ''; // Go back to landing page
            });
        }

        // Task Form Submission (includes previous date validation fix)
        if (taskForm) {
            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const description = taskInput.value.trim();
                const dateTimeValue = taskDateTimeInput.value;

                if (!description || !dateTimeValue) {
                    setStatus('Please enter both task description and date/time.', true);
                    return;
                }

                // Robust date validation before sending to backend
                const localDate = new Date(dateTimeValue);
                if (isNaN(localDate.getTime())) {
                    setStatus('The entered date and time is invalid. Please use a valid format (e.g., YYYY-MM-DDTHH:MM).', true);
                    return;
                }

                const scheduledAt = localDate.toISOString(); // Convert local date object to UTC ISO string for backend

                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        setStatus('Please log in to add tasks.', true);
                        return;
                    }
                    const response = await fetch(`${API_BASE_URL}/tasks`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ description, dateTime: scheduledAt }) // Send as 'dateTime' to match backend
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Error adding task');
                    }

                    const newTask = await response.json();
                    setStatus('Task added successfully!', false);
                    taskInput.value = ''; // Clear input fields
                    taskDateTimeInput.value = '';
                    fetchTasks(); // Refresh the task list display
                    closeModal(taskModal); // Close the task modal after successful submission
                } catch (error) {
                    setStatus(`Error adding task: ${error.message}`, true);
                    console.error('Error adding task:', error);
                }
            });
        }

        // --- AI Voice Assistant Logic ---
        if (('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) && voiceAssistantBtn) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.continuous = false; // Recognizes a single utterance
            recognition.interimResults = false; // Returns only final results
            recognition.lang = 'en-US'; // Set language

            voiceAssistantBtn.addEventListener('click', () => {
                if (synth.speaking) {
                    synth.cancel(); // Stop any current speech
                }
                recognition.start(); // Start listening
                setAssistantStatus('Listening...');
                speak('Listening...');
            });

            recognition.onresult = (event) => {
                const commandText = event.results[0][0].transcript.toLowerCase().trim();
                setAssistantStatus(`Heard: "${commandText}"`);
                console.log('Voice command:', commandText);

                let responseText = "Sorry, I didn't understand that. Please try again.";
                let actionPerformed = false;

                // Command for adding a task with description and date/time
                const taskMatch = commandText.match(/(?:add|create|schedule) (?:my )?tasks?(?: called)? (.+?) (?:for|on|at) (.+)/);
                if (taskMatch) {
                    const description = taskMatch[1].trim();
                    const dateTimeString = taskMatch[2].trim();
                    const parsedDate = parseNaturalDateTime(dateTimeString); // Use the natural language parser

                    if (!isNaN(parsedDate.getTime())) { // Check if the parsed date is valid
                        taskInput.value = description;
                        taskDateTimeInput.value = parsedDate.toISOString().slice(0, 16); // Format for datetime-local input
                        // Dispatch a submit event on the form to trigger the task creation logic
                        // This will also run the form's own validation (including the new date validation).
                        taskForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                        responseText = `Attempting to add task: "${description}" for ${parsedDate.toLocaleString()}.`;
                        actionPerformed = true;
                    } else {
                        responseText = `Could not fully understand the date and time from "${dateTimeString}". Please try a format like "tomorrow at 5 PM" or "July 16th 2025 at 9 AM".`;
                        taskDateTimeInput.value = ''; // Clear input if parsing failed
                        // Do NOT dispatch the form submit event if date parsing failed!
                        // The user will need to manually correct the date/time in the input field.
                        actionPerformed = true; // Indicate that a command was recognized, even if not fully actionable.
                    }
                }
                // Command for greeting
                else if (commandText.includes('hello') || commandText.includes('hi')) {
                    responseText = "Hello there! How can I help you today?";
                    actionPerformed = true;
                }
                // Command for goodbye
                else if (commandText.includes('goodbye') || commandText.includes('bye')) {
                    responseText = "Goodbye! Have a great day.";
                    actionPerformed = true;
                }

                speak(responseText); // Speak the response
                setAssistantStatus(responseText); // Display the spoken response in status area
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                setAssistantStatus(`Error: ${event.error}`);
                speak(`Error: ${event.error}`);
            };

            recognition.onend = () => {
                // Reset status after recognition ends, unless new speech is queued
                if (!currentUtterance || !synth.speaking) {
                    setAssistantStatus('Click to speak');
                }
            };
            window.speak = speak; // Make speak accessible globally if needed (e.g., from console)
        } else {
            // Browser does not support Web Speech API
            if (voiceAssistantBtn) voiceAssistantBtn.style.display = 'none';
            setStatus('Voice assistant not supported in this browser. Please use Chrome or Edge.', true);
        }
        // --- End AI Voice Assistant Logic ---


        // Initial Render calls
        renderCalendar();
        // fetchTasks(); // Initial fetch of tasks is now handled by updateAuthUI based on login status

        // Check login status on page load
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        updateAuthUI(isLoggedIn); // Update UI based on initial login status

        // Event listener for "Get Started" button to open auth modal or redirect
        if (getStartedBtn) {
            getStartedBtn.addEventListener('click', () => {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                if (isLoggedIn) {
                    window.location.href = '#tasks'; // If already logged in, redirect to tasks section
                } else {
                    openAuthModal(); // If not logged in, open the auth modal
                }
            });
        }

        // Modal close buttons (assuming you have close buttons for authModal and taskModal)
        const authModalCloseBtn = document.getElementById('authModalCloseBtn');
        if (authModalCloseBtn) {
            authModalCloseBtn.addEventListener('click', () => closeModal(authModal));
        }
        if (taskModalCloseBtn) {
            taskModalCloseBtn.addEventListener('click', () => closeModal(taskModal));
        }
        // Close modals when the backdrop is clicked
        const modalBackdrop = document.getElementById('modal-backdrop');
        if (modalBackdrop) {
            modalBackdrop.addEventListener('click', () => {
                closeModal(authModal);
                closeModal(taskModal); // Close all potentially open modals
            });
        }
    }); // End DOMContentLoaded
</script>
</body>
</html>
