<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="Calndo - AI-powered calendar for seamless task and event scheduling." name="description"/>
<meta content="AI calendar, task scheduling, event planning, productivity" name="keywords"/>
<meta content="Calndo" name="author"/>
<title>Calndo - AI-Powered Scheduling</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #4FD1C5, #4299E1); }
        .fab { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .header-transparent { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .active-day {
            background-color: #4FD1C5; /* A light teal for active day */
            color: white;
            border-radius: 9999px; /* Make it circular */
            font-weight: 600;
        }
        .today-day {
            border: 2px solid #4299E1; /* A distinct border for today */
            border-radius: 9999px;
            font-weight: 600;
        }
        /* Style for the voice assistant button */
        #voiceAssistantBtn {
            background: linear-gradient(135deg, #4FD1C5, #4299E1); /* Same gradient as header */
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: fixed; /* Keep it fixed */
            bottom: 20px; /* Adjust as needed */
            right: 20px; /* Adjust as needed */
            z-index: 1000; /* Ensure it's above other content */
        }
        #voiceAssistantBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        /* For the modal backdrop */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Style for required fields */
        .required-label::after {
            content: '*';
            color: red;
            margin-left: 4px;
        }
</style>
</head>
<body>

<div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-[1001] modal-overlay">
    <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/3 mx-auto">
        <div id="modalHeader" class="p-4 rounded-t-lg bg-blue-500 text-white flex justify-between items-center">
            <h3 class="text-lg font-semibold">Voice Assistant Message</h3>
            <button id="modalCloseButton" class="text-white hover:text-gray-200">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="p-4">
            <p id="modalMessage" class="text-gray-700"></p>
        </div>
    </div>
</div>

<div id="authModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Welcome to Calndo</h2>
        <div class="flex flex-col space-y-4">
            <button id="loginBtn" class="w-full bg-blue-500 text-white py-3 rounded-md hover:bg-blue-600 transition duration-300">Login with Email</button>
            <button id="signupBtn" class="w-full bg-green-500 text-white py-3 rounded-md hover:bg-green-600 transition duration-300">Sign Up with Email</button>
        </div>
        <p class="text-center text-gray-500 text-sm mt-6">By continuing, you agree to Calndo's Terms of Service and Privacy Policy.</p>
    </div>
</div>

<div id="emailAuthModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto relative">
        <button id="closeEmailAuthModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        <h2 id="emailAuthTitle" class="text-2xl font-bold text-center text-gray-800 mb-6">Login</h2>
        <form id="emailAuthForm" class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 required-label">Email</label>
                <input type="email" id="email" name="email" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 required-label">Password</label>
                <input type="password" id="password" name="password" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            <button type="submit" id="emailAuthSubmit"
                    class="w-full bg-blue-500 text-white py-3 rounded-md hover:bg-blue-600 transition duration-300">Submit</button>
        </form>
    </div>
</div>

<header class="header-transparent absolute top-0 left-0 right-0 z-10 p-4">
    <nav class="container mx-auto flex justify-between items-center">
        <a href="#" class="text-2xl font-bold text-gray-800">Calndo</a>
        <div class="space-x-4">
            <button id="logoutBtn" class="hidden bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-300">Logout</button>
        </div>
    </nav>
</header>

<main>
    <section id="hero" class="relative gradient-bg flex items-center justify-center min-h-screen text-white text-center p-6">
        <div class="relative z-10" data-aos="fade-up" data-aos-duration="1000">
            <h1 class="text-5xl md:text-6xl font-extrabold leading-tight mb-4">
                Effortless Scheduling, <br/> Powered by AI.
            </h1>
            <p class="text-xl md:text-2xl mb-8 opacity-90">
                Manage your tasks and events seamlessly with intelligent suggestions.
            </p>
            <button id="getStartedBtn" class="bg-white text-blue-600 px-8 py-3 rounded-full text-lg font-semibold shadow-lg hover:bg-gray-100 transform hover:scale-105 transition duration-300">
                Get Started
            </button>
        </div>
    </section>

    <section id="tasks" class="container mx-auto mt-8 p-6 hidden">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Your Schedule</h2>

        <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Prev</button>
            <h3 id="currentMonthYear" class="text-xl font-semibold"></h3>
            <button id="nextMonth" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Next</button>
        </div>

        <div id="calendar" class="grid grid-cols-7 gap-2 text-center text-sm mb-8">
            <div class="font-semibold text-gray-600">Sun</div>
            <div class="font-semibold text-gray-600">Mon</div>
            <div class="font-semibold text-gray-600">Tue</div>
            <div class="font-semibold text-gray-600">Wed</div>
            <div class="font-semibold text-gray-600">Thu</div>
            <div class="font-semibold text-gray-600">Fri</div>
            <div class="font-semibold text-gray-600">Sat</div>
        </div>

        <h3 id="tasksForDate" class="text-2xl font-bold text-gray-700 mb-4 text-center"></h3>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h4 class="text-xl font-semibold text-gray-800 mb-4">Add New Task</h4>
            <form id="addTaskForm" class="space-y-4">
                <div>
                    <label for="taskDescription" class="block text-sm font-medium text-gray-700 required-label">Task Description</label>
                    <input type="text" id="taskDescription" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="taskDateTime" class="block text-sm font-medium text-gray-700 required-label">Date and Time</label>
                    <input type="datetime-local" id="taskDateTime" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-300">Add Task</button>
            </form>
        </div>

        <div id="taskList" class="space-y-4">
            <p id="noTasksMessage" class="text-center text-gray-500 hidden">No tasks for this day. Enjoy your free time!</p>
        </div>
    </section>
</main>

<button id="voiceAssistantBtn" class="fab">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 10-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
    </svg>
</button>
<div id="assistantStatus" class="fixed bottom-20 right-20 bg-white p-2 rounded shadow-lg text-sm text-gray-600 z-50 hidden"></div>


<script>
    AOS.init();

    // EmailJS initialization (moved to top of script)
    (function() {
        emailjs.init({
            publicKey: "YOUR_EMAILJS_PUBLIC_KEY", // Replace with your actual Public Key
        });
    })();

    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'http://localhost:5000/api'; // Your backend API base URL

        const authModal = document.getElementById('authModal');
        const emailAuthModal = document.getElementById('emailAuthModal');
        const closeEmailAuthModal = document.getElementById('closeEmailAuthModal');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const emailAuthTitle = document.getElementById('emailAuthTitle');
        const emailAuthForm = document.getElementById('emailAuthForm');
        const emailAuthSubmit = document.getElementById('emailAuthSubmit');
        const logoutBtn = document.getElementById('logoutBtn');
        const heroSection = document.getElementById('hero');
        const tasksSection = document.getElementById('tasks');
        const getStartedBtn = document.getElementById('getStartedBtn');

        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const tasksForDateEl = document.getElementById('tasksForDate');
        const taskListEl = document.getElementById('taskList');
        const addTaskForm = document.getElementById('addTaskForm');
        const taskDescriptionInput = document.getElementById('taskDescription');
        const taskDateTimeInput = document.getElementById('taskDateTime');
        const noTasksMessage = document.getElementById('noTasksMessage');

        let currentDate = new Date(); // Current date for calendar view

        // --- Auth Functions ---
        const openAuthModal = () => {
            authModal.classList.remove('hidden');
        };

        const closeAuthModal = () => {
            authModal.classList.add('hidden');
        };

        const openEmailAuthModal = (type) => {
            emailAuthModal.classList.remove('hidden');
            emailAuthTitle.textContent = type === 'login' ? 'Login' : 'Sign Up';
            emailAuthSubmit.textContent = type === 'login' ? 'Login' : 'Sign Up';
            emailAuthForm.dataset.type = type; // Store type for form submission
            closeAuthModal(); // Close the initial auth selection modal
        };

        const closeEmailAuthModalFunc = () => {
            emailAuthModal.classList.add('hidden');
            emailAuthForm.reset();
        };

        const updateAuthUI = (isLoggedIn) => {
            if (isLoggedIn) {
                heroSection.classList.add('hidden');
                tasksSection.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                getStartedBtn.classList.add('hidden');
                closeAuthModal();
                closeEmailAuthModalFunc();
                fetchTasks(currentDate); // Fetch tasks for the current day on login
            } else {
                heroSection.classList.remove('hidden');
                tasksSection.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                getStartedBtn.classList.remove('hidden');
            }
        };

        // Event Listeners for Auth Modals
        loginBtn.addEventListener('click', () => openEmailAuthModal('login'));
        signupBtn.addEventListener('click', () => openEmailAuthModal('signup'));
        closeEmailAuthModal.addEventListener('click', closeEmailAuthModalFunc);

        emailAuthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const type = emailAuthForm.dataset.type;
            const endpoint = type === 'login' ? 'login' : 'register';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('isLoggedIn', 'true');
                    updateAuthUI(true);
                    alert(`Successfully ${type === 'login' ? 'logged in' : 'signed up'}!`);
                } else {
                    alert(`Error: ${data.message || 'Something went wrong.'}`);
                }
            } catch (error) {
                console.error('Auth error:', error);
                alert('An error occurred during authentication.');
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('isLoggedIn');
            updateAuthUI(false);
            alert('Logged out successfully!');
        });

        // --- Task Functions ---
        const fetchTasks = async (date) => {
            const token = localStorage.getItem('token');
            if (!token) return;

            // Calculate start and end of the selected day in UTC for backend query
            const startOfDayUtc = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0)).toISOString();
            const endOfDayExclusiveUtc = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate() + 1, 0, 0, 0, 0)).toISOString();

            tasksForDateEl.textContent = `Tasks for ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            taskListEl.innerHTML = ''; // Clear previous tasks
            noTasksMessage.classList.add('hidden');

            try {
                const url = `${API_BASE_URL}/tasks?start=${encodeURIComponent(startOfDayUtc)}&end=${encodeURIComponent(endOfDayExclusiveUtc)}`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const tasks = await response.json();

                if (response.ok) {
                    if (tasks.length === 0) {
                        noTasksMessage.classList.remove('hidden');
                    } else {
                        tasks.forEach(task => {
                            const taskItem = document.createElement('div');
                            taskItem.className = 'bg-white p-4 rounded-lg shadow-md flex items-center justify-between';
                            const taskDateTime = new Date(task.dateTime);
                            taskItem.innerHTML = `
                                <div>
                                    <h5 class="font-semibold text-lg ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${task.description}</h5>
                                    <p class="text-sm text-gray-600">${taskDateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" data-id="${task._id}" ${task.completed ? 'checked' : ''} class="task-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                                    <button data-id="${task._id}" class="edit-task-btn text-blue-500 hover:text-blue-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.586 3.586l-2.828 2.828-5.657 5.657a1 1 0 00.343 1.03l.911.911a1 1 0 001.03.343l5.657-5.657 2.828-2.828-2.828-2.828z" />
                                        </svg>
                                    </button>
                                    <button data-id="${task._id}" class="delete-task-btn text-red-500 hover:text-red-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm1 3a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            `;
                            taskListEl.appendChild(taskItem);
                        });
                    }
                    attachTaskEventListeners();
                } else {
                    console.error('Failed to fetch tasks:', tasks.message);
                    alert('Failed to load tasks. Please try again.');
                }
            } catch (error) {
                console.error('Error fetching tasks:', error);
                alert('An error occurred while fetching tasks.');
            }
        };

        const attachTaskEventListeners = () => {
            document.querySelectorAll('.delete-task-btn').forEach(button => {
                button.onclick = (e) => deleteTask(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.edit-task-btn').forEach(button => {
                button.onclick = (e) => editTask(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.onchange = (e) => toggleTaskCompleted(e.currentTarget.dataset.id, e.currentTarget.checked);
            });
        };

        const deleteTask = async (id) => {
            const token = localStorage.getItem('token');
            if (!confirm('Are you sure you want to delete this task?')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    alert('Task deleted successfully!');
                    fetchTasks(currentDate); // Refresh tasks after deletion
                } else {
                    const data = await response.json();
                    alert(`Failed to delete task: ${data.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('An error occurred while deleting the task.');
            }
        };

        const editTask = async (id) => {
            const token = localStorage.getItem('token');
            const newDescription = prompt('Enter new description:');
            if (newDescription === null || newDescription.trim() === '') return;

            // You might want a more sophisticated modal for editing both description and time
            try {
                const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ description: newDescription })
                });
                if (response.ok) {
                    alert('Task updated successfully!');
                    fetchTasks(currentDate);
                } else {
                    const data = await response.json();
                    alert(`Failed to update task: ${data.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Error updating task:', error);
                alert('An error occurred while updating the task.');
            }
        };

        const toggleTaskCompleted = async (id, completed) => {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE_URL}/tasks/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ completed })
                });
                if (response.ok) {
                    // Update UI without full re-fetch for responsiveness
                    const taskItem = document.querySelector(`button[data-id="${id}"]`).closest('.flex.items-center.justify-between');
                    if (taskItem) {
                        const descriptionEl = taskItem.querySelector('h5');
                        if (completed) {
                            descriptionEl.classList.add('line-through', 'text-gray-500');
                            descriptionEl.classList.remove('text-gray-800');
                        } else {
                            descriptionEl.classList.remove('line-through', 'text-gray-500');
                            descriptionEl.classList.add('text-gray-800');
                        }
                    }
                    // Optionally re-fetch to ensure consistency if complex logic is involved
                    // fetchTasks(currentDate);
                } else {
                    const data = await response.json();
                    alert(`Failed to update task status: ${data.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Error toggling task completed status:', error);
                alert('An error occurred while updating the task status.');
            }
        };


        addTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = taskDescriptionInput.value;
            const dateTime = new Date(taskDateTimeInput.value).toISOString(); // Send as ISO string (UTC)
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_BASE_URL}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ description, dateTime })
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Task added successfully!');
                    taskDescriptionInput.value = '';
                    taskDateTimeInput.value = '';
                    fetchTasks(currentDate); // Refresh tasks
                } else {
                    alert(`Error adding task: ${data.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Add task error:', error);
                alert('An error occurred while adding the task.');
            }
        });

        // --- Calendar Functions ---
        const renderCalendar = () => {
            calendarEl.innerHTML = `
                <div class="font-semibold text-gray-600">Sun</div>
                <div class="font-semibold text-gray-600">Mon</div>
                <div class="font-semibold text-gray-600">Tue</div>
                <div class="font-semibold text-gray-600">Wed</div>
                <div class="font-semibold text-gray-600">Thu</div>
                <div class="font-semibold text-gray-600">Fri</div>
                <div class="font-semibold text-gray-600">Sat</div>
            `; // Clear and re-add headers

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            currentMonthYearEl.textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();

            // Add empty divs for the days before the 1st of the month
            for (let i = 0; i < firstDayOfMonth.getDay(); i++) {
                calendarEl.innerHTML += '<div></div>';
            }

            // Add days of the month
            const today = new Date(); // Get today's date once
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.textContent = day;
                dayDiv.className = 'p-2 cursor-pointer hover:bg-gray-200 rounded-full flex items-center justify-center';
                dayDiv.dataset.day = day;

                const fullDate = new Date(year, month, day);

                // Add 'today-day' class if it's today's date
                if (fullDate.getDate() === today.getDate() &&
                    fullDate.getMonth() === today.getMonth() &&
                    fullDate.getFullYear() === today.getFullYear()) {
                    dayDiv.classList.add('today-day');
                }

                // Add 'active-day' class if it's the currently selected date
                if (fullDate.getDate() === currentDate.getDate() &&
                    fullDate.getMonth() === currentDate.getMonth() &&
                    fullDate.getFullYear() === currentDate.getFullYear()) {
                    dayDiv.classList.add('active-day');
                }

                dayDiv.addEventListener('click', () => {
                    currentDate.setDate(parseInt(dayDiv.dataset.day));
                    renderCalendar(); // Re-render to update active day class
                    fetchTasks(currentDate); // Fetch tasks for the selected day
                });
                calendarEl.appendChild(dayDiv);
            }
        };

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
            fetchTasks(currentDate);
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
            fetchTasks(currentDate);
        });

        // --- AI Voice Assistant Logic ---
        if ('speechSynthesis' in window && 'SpeechRecognition' in window) {
            const voiceAssistantBtn = document.getElementById('voiceAssistantBtn');
            const assistantStatus = document.getElementById('assistantStatus');
            const messageModal = document.getElementById('messageModal'); // Get modal elements
            const modalMessage = document.getElementById('modalMessage');
            const modalHeader = document.getElementById('modalHeader');
            const modalCloseButton = document.getElementById('modalCloseButton');


            let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const synth = window.speechSynthesis;

            voiceAssistantBtn.addEventListener('click', () => {
                setStatus('Listening...', false);
                assistantStatus.classList.remove('hidden'); // Show status div
                recognition.start();
            });

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript.toLowerCase();
                setStatus(`Heard: "${speechResult}"`, false);
                processCommand(speechResult);
            };

            recognition.onerror = (event) => {
                setStatus(`Speech recognition error: ${event.error}`, true);
                console.error('Speech recognition error:', event.error);
                 assistantStatus.classList.remove('hidden'); // Ensure status is visible for error
                 setTimeout(() => assistantStatus.classList.add('hidden'), 3000); // Hide after 3 seconds
            };

            recognition.onend = () => {
                // Optionally hide status after a short delay if no error
                if (!assistantStatus.classList.contains('text-red-500')) {
                     setTimeout(() => assistantStatus.classList.add('hidden'), 1500);
                }
            };

            const speak = (text) => {
                const utterance = new SpeechSynthesisUtterance(text);
                synth.speak(utterance);
            };

            const setStatus = (message, isError = false) => {
                assistantStatus.textContent = message;
                assistantStatus.className = `fixed bottom-20 right-20 bg-white p-2 rounded shadow-lg text-sm ${isError ? 'text-red-500' : 'text-gray-600'} z-50`;
            };

            // New helper function for showing messages on the UI
            const showModalMessage = (message, type = 'info') => {
                if (!messageModal || !modalMessage || !modalHeader || !modalCloseButton) {
                    console.warn("Message modal elements not found, falling back to alert.");
                    alert(message); // Fallback to alert if modal elements are missing
                    return;
                }

                modalMessage.textContent = message;
                modalHeader.className = `p-4 rounded-t-lg ${type === 'error' ? 'bg-red-500' : 'bg-blue-500'} text-white`;
                messageModal.classList.remove('hidden');

                // Close button handler
                modalCloseButton.onclick = () => {
                    messageModal.classList.add('hidden');
                };
                // Click outside modal handler
                messageModal.querySelector('.modal-overlay').onclick = (e) => {
                    if (e.target.classList.contains('modal-overlay')) {
                        messageModal.classList.add('hidden');
                    }
                };
            };


            // New helper function to parse natural language date/time (simplified)
            // This function attempts to convert phrases like "tomorrow at 3 PM" into an ISO string.
            // For robust parsing, consider dedicated NLP libraries or services.
            const parseNaturalDateTime = (text, baseDate = new Date()) => {
                let date = new Date(baseDate);
                date.setSeconds(0);
                date.setMilliseconds(0);

                const currentHour = date.getHours();

                // Keywords for today/tomorrow/days of week
                if (text.includes('today')) {
                    // No change to date, as baseDate is usually today
                } else if (text.includes('tomorrow')) {
                    date.setDate(date.getDate() + 1);
                } else if (text.includes('next week')) {
                    date.setDate(date.getDate() + 7);
                } else {
                    const daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                    let foundDay = false;
                    for (let i = 0; i < daysOfWeek.length; i++) {
                        if (text.includes(daysOfWeek[i])) {
                            let targetDay = i;
                            let currentDay = date.getDay();
                            let diff = targetDay - currentDay;
                            if (diff < 0 || (diff === 0 && text.includes('next'))) {
                                diff += 7;
                            }
                            date.setDate(date.getDate() + diff);
                            foundDay = true;
                            break;
                        }
                    }
                }

                // Time parsing (e.g., "3 PM", "10 o'clock", "14:00")
                const timeRegex = /(\d{1,2}(:\d{2})?\s*(am|pm|o'clock)?)|(\d{1,2}:\d{2})/i;
                const timeMatch = text.match(timeRegex);
                if (timeMatch) {
                    let [hour, minute] = [0, 0];
                    let timeStr = timeMatch[0].toLowerCase();

                    if (timeStr.includes('am') && !timeStr.startsWith('12')) {
                        hour = parseInt(timeStr);
                    } else if (timeStr.includes('pm') && !timeStr.startsWith('12')) {
                        hour = parseInt(timeStr) + 12;
                    } else if (timeStr.includes('12pm')) { // Specific handling for 12 PM
                        hour = 12;
                    } else if (timeStr.includes('12am')) { // Specific handling for 12 AM (midnight)
                        hour = 0;
                    } else if (timeStr.includes(':')) {
                        [hour, minute] = timeStr.split(':').map(Number);
                    } else if (timeStr.includes("o'clock")) {
                        hour = parseInt(timeStr);
                    } else { // Assume 24-hour format or just the hour (e.g., "at 9")
                        hour = parseInt(timeStr);
                        // Simple AM/PM inference: if hour is less than current hour and no AM/PM, assume PM if > 12.
                        // This is very basic and can be improved.
                        if (hour < 12 && text.includes('pm')) hour += 12;
                        if (hour === 12 && text.includes('am')) hour = 0; // 12 AM is midnight
                    }
                    date.setHours(hour, minute, 0, 0);
                } else {
                    // If no time is explicitly mentioned, set a default sensible time or keep current time
                    // For "tomorrow", default to 9 AM
                    // For "today", default to next hour or 9 AM if early
                    if (text.includes('tomorrow') || date.getDate() !== baseDate.getDate()) {
                        date.setHours(9, 0, 0, 0); // Default to 9 AM for future days
                    } else {
                        // If it's today and no time is given, default to 1 hour from now or 9 AM if current time is very early.
                        if (currentHour < 9) {
                            date.setHours(9, 0, 0, 0);
                        } else {
                            date.setHours(currentHour + 1, 0, 0, 0); // Default to next full hour
                        }
                    }
                }
                return date.toISOString(); // Return as UTC ISO string for backend
            };


            // Updated processCommand to handle more complex language and backend calls
            const processCommand = async (command) => {
                let responseText = "I didn't understand that. Can you please rephrase?";
                let actionPerformed = false;

                // Basic greetings and info
                if (command.includes('hello') || command.includes('hi')) {
                    responseText = "Hello there! How can I help you today?";
                    actionPerformed = true;
                } else if (command.includes('what can you do')) {
                    responseText = "I can help you add tasks, fetch tasks, update tasks, delete tasks, and suggest times for tasks. Just tell me what you need!";
                    actionPerformed = true;
                } else if (command.includes('goodbye') || command.includes('bye')) {
                    responseText = "Goodbye! Have a great day.";
                    actionPerformed = true;
                }
                // Add Task
                else if (command.includes('add a task') || command.includes('create a task') || command.includes('add task') || command.includes('create task')) {
                    // Regex to capture description and optional date/time phrase
                    const taskRegex = /(?:add a task to|create a task to|add task|create task)\s+(.+?)(?:\s+(?:on|for|at|by)\s+(.+))?$/i;
                    const match = command.match(taskRegex);

                    if (match && match[1]) {
                        const description = match[1].trim();
                        let dateTimeString = match[2] ? match[2].trim() : '';

                        let dateTime;
                        if (dateTimeString) {
                            dateTime = parseNaturalDateTime(dateTimeString, currentDate); // Use currentDate as base for parsing
                        } else {
                            // If no date/time specified, default to tomorrow at 9 AM
                            const tomorrow = new Date(currentDate);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            tomorrow.setHours(9, 0, 0, 0);
                            dateTime = tomorrow.toISOString();
                        }

                        try {
                            const token = localStorage.getItem('token');
                            if (!token) {
                                responseText = "You need to be logged in to add tasks.";
                                showModalMessage(responseText, 'error');
                                actionPerformed = true;
                                return;
                            }
                            const response = await fetch(`${API_BASE_URL}/tasks`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ description, dateTime })
                            });
                            const data = await response.json();
                            if (response.ok) {
                                responseText = `Task "${data.description}" added for ${new Date(data.dateTime).toLocaleString()}.`;
                                await fetchTasks(currentDate); // Refresh calendar tasks for the current view
                            } else {
                                responseText = `Failed to add task: ${data.message || response.statusText}.`;
                            }
                        } catch (error) {
                            console.error('Error adding task:', error);
                            responseText = `An error occurred while adding the task. Please try again.`;
                        }
                        actionPerformed = true;
                    } else {
                        responseText = "I couldn't understand the task details. Please say something like 'add a task to call John tomorrow at 3 PM'.";
                        actionPerformed = true;
                    }
                }
                // Suggest Task Time
                else if (command.includes('suggest a time for')) {
                    const suggestRegex = /(?:suggest a time for)\s+(.+)$/i;
                    const match = command.match(suggestRegex);

                    if (match && match[1]) {
                        const description = match[1].trim();
                        try {
                            const token = localStorage.getItem('token');
                            if (!token) {
                                responseText = "You need to be logged in to get task suggestions.";
                                showModalMessage(responseText, 'error');
                                actionPerformed = true;
                                return;
                            }
                            const response = await fetch(`${API_BASE_URL}/tasks/suggest-time`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ description })
                            });
                            const data = await response.json();
                            if (response.ok) {
                                responseText = data.message;
                            } else {
                                responseText = `Failed to get suggestion: ${data.message || response.statusText}.`;
                            }
                        } catch (error) {
                            console.error('Error getting AI suggestion:', error);
                            responseText = `An error occurred while getting a suggestion. Please try again.`;
                        }
                        actionPerformed = true;
                    } else {
                        responseText = "I couldn't understand the task description for suggestion. Please say something like 'suggest a time for meeting with team'.";
                        actionPerformed = true;
                    }
                }
                // Fetch Tasks for a specific Date
                else if (command.includes('show tasks for')) {
                    const datePhrase = command.replace('show tasks for', '').trim();
                    if (datePhrase) {
                        let targetDate = null;
                        if (datePhrase.includes('today')) {
                            targetDate = new Date();
                        } else if (datePhrase.includes('tomorrow')) {
                            targetDate = new Date();
                            targetDate.setDate(targetDate.getDate() + 1);
                        } else if (datePhrase.includes('next week')) {
                             targetDate = new Date();
                             targetDate.setDate(targetDate.getDate() + 7);
                        } else {
                            // Try to parse direct date string (e.g., "July 20th", "2025-07-20")
                            let tempDate = new Date(datePhrase);
                            if (!isNaN(tempDate.getTime())) {
                                targetDate = tempDate;
                            }
                        }

                        if (targetDate) {
                            currentDate = targetDate; // Update the calendar's current date
                            renderCalendar(); // Re-render calendar to highlight new date
                            await fetchTasks(currentDate); // Fetch tasks for the new date
                            responseText = `Showing tasks for ${currentDate.toLocaleDateString()}.`;
                        } else {
                            responseText = "I couldn't understand the date. Please specify a valid date like 'show tasks for today' or 'show tasks for July 20th'.";
                        }
                        actionPerformed = true;
                    } else {
                        responseText = "Please specify a date, like 'show tasks for tomorrow'.";
                        actionPerformed = true;
                    }
                }

                if (!actionPerformed) {
                    speak(responseText); // Speak the generic "didn't understand" response
                    setStatus(responseText); // Display the status
                } else {
                    speak(responseText); // Speak the specific action response
                    setStatus(responseText); // Display the status
                    if (responseText.includes("Failed") || responseText.includes("error occurred") || responseText.includes("need to be logged in")) {
                         showModalMessage(responseText, 'error'); // Show error in modal too
                    } else {
                        showModalMessage(responseText); // Show success in modal
                    }
                }
            };


            window.speak = speak;
        } else {
            // Browser does not support Web Speech API
            voiceAssistantBtn.style.display = 'none';
            // Hide status display as it's not needed if assistant is not supported
            assistantStatus.style.display = 'none';
            showModalMessage('Voice assistant not supported in this browser. Please use Chrome or Edge.', 'error');
        }
        // --- End AI Voice Assistant Logic ---


        // Initial Render calls
        renderCalendar();
        // fetchTasks(); // Initial fetch of tasks is now handled by updateAuthUI

        // Check login status on page load
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        updateAuthUI(isLoggedIn); // Update UI based on initial login status

        // Event listener for "Get Started" button to open auth modal or go to tasks
        if (getStartedBtn) {
            getStartedBtn.addEventListener('click', () => {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                if (isLoggedIn) {
                    window.location.href = '#tasks'; // If already logged in, redirect to tasks section
                } else {
                    openAuthModal(); // If not logged in, open the auth modal
                }
            });
        }

    }); // End DOMContentLoaded
</script>
</body>
</html>
